name: mini-runrun-gitops-ci

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]
  workflow_dispatch:

jobs:
  validate:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Install Helm
        uses: azure/setup-helm@v4
        with:
          version: v3.15.4

      - name: Lint Helm chart
        run: |
          if [ -d "helm-chart" ]; then
            helm lint helm-chart
          else
            echo "No helm-chart directory"
          fi

      - name: Render Helm templates
        run: |
          if [ -d "helm-chart" ]; then
            helm template mini-runrun helm-chart --namespace devsecops-demo > rendered.yaml
            echo "Helm rendered successfully:"
            head -n 30 rendered.yaml || true
          else
            echo "No helm-chart directory"
          fi

      - name: Validate raw YAML in manifests/
        run: |
          if [ -d "manifests" ]; then
            echo "Validating YAML files in manifests/"
            pip install pyyaml
            python3 << 'PY'
import glob, yaml, sys

files = glob.glob("manifests/*.yaml")
if not files:
    print("No manifests found")
    sys.exit(0)

for f in files:
    print(f"Checking {f}")
    with open(f, 'r') as fh:
        try:
            list(yaml.safe_load_all(fh))
        except yaml.YAMLError as e:
            print(f"Error in {f}: {e}")
            sys.exit(1)

print("All manifests validated successfully!")
PY
          else:
            echo "No manifests directory"
          fi
